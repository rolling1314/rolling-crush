# 🏗️ Crush JWT 认证系统架构图

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                           用户浏览器                                  │
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                    前端应用 (React)                           │   │
│  │                   http://localhost:5173                       │   │
│  │                                                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │  │ LoginPage   │  │ ChatPanel   │  │  FileTree   │         │   │
│  │  │             │  │             │  │             │         │   │
│  │  │ - 用户名    │  │ - 消息列表  │  │ - 文件列表  │         │   │
│  │  │ - 密码      │  │ - 输入框    │  │ - 选择文件  │         │   │
│  │  │ - 登录按钮  │  │ - 工具调用  │  │             │         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │
│  │         │                  │                                 │   │
│  │         │                  │                                 │   │
│  │  ┌──────▼──────────────────▼─────────────────────────────┐  │   │
│  │  │              App.tsx (状态管理)                        │  │   │
│  │  │                                                        │  │   │
│  │  │  - isAuthenticated: boolean                           │  │   │
│  │  │  - jwtToken: string                                   │  │   │
│  │  │  - wsConnection: WebSocket                            │  │   │
│  │  │  - messages: Message[]                                │  │   │
│  │  └────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────┘   │
│           │                           │                              │
│           │ HTTP POST                 │ WebSocket                    │
│           │ /api/auth/login           │ /ws?token=xxx                │
│           │                           │                              │
└───────────┼───────────────────────────┼──────────────────────────────┘
            │                           │
            │                           │
            ▼                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         后端服务器 (Go)                              │
│                                                                       │
│  ┌──────────────────────┐          ┌──────────────────────┐         │
│  │   HTTP Server        │          │   WebSocket Server   │         │
│  │   :8081              │          │   :8080              │         │
│  │                      │          │                      │         │
│  │  ┌────────────────┐  │          │  ┌────────────────┐  │         │
│  │  │ /api/auth/     │  │          │  │ /ws            │  │         │
│  │  │   login        │  │          │  │                │  │         │
│  │  │   verify       │  │          │  │ - 验证 JWT     │  │         │
│  │  │                │  │          │  │ - 升级连接     │  │         │
│  │  │ /health        │  │          │  │ - 消息处理     │  │         │
│  │  └────────────────┘  │          │  └────────────────┘  │         │
│  │         │             │          │         │            │         │
│  └─────────┼─────────────┘          └─────────┼────────────┘         │
│            │                                   │                      │
│            │                                   │                      │
│  ┌─────────▼───────────────────────────────────▼────────────┐        │
│  │              认证模块 (internal/auth/)                    │        │
│  │                                                            │        │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │        │
│  │  │   jwt.go     │  │   user.go    │  │ middleware.go│   │        │
│  │  │              │  │              │  │              │   │        │
│  │  │ - Generate   │  │ - UserStore  │  │ - Auth       │   │        │
│  │  │   Token      │  │ - Authen     │  │   Middleware │   │        │
│  │  │ - Validate   │  │   ticate     │  │              │   │        │
│  │  │   Token      │  │ - Hash       │  │              │   │        │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │        │
│  │         │                  │                             │        │
│  └─────────┼──────────────────┼─────────────────────────────┘        │
│            │                  │                                       │
│            ▼                  ▼                                       │
│  ┌─────────────────────────────────────────────────────────┐         │
│  │              内存用户存储 (开发环境)                      │         │
│  │                                                           │         │
│  │  users = {                                                │         │
│  │    "admin": {                                             │         │
│  │      id: "507c7f79...",                                   │         │
│  │      username: "admin",                                   │         │
│  │      password: "hashed_password"                          │         │
│  │    },                                                     │         │
│  │    "user": { ... }                                        │         │
│  │  }                                                        │         │
│  └───────────────────────────────────────────────────────────┘         │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

## 认证流程详解

### 1. 用户登录流程

```
┌──────────┐                                                    ┌──────────┐
│  前端    │                                                    │  后端    │
└────┬─────┘                                                    └────┬─────┘
     │                                                               │
     │  1. 用户输入用户名和密码                                      │
     │     点击"登录"按钮                                            │
     │                                                               │
     │  2. POST /api/auth/login                                     │
     │     { username: "admin", password: "admin123" }              │
     ├──────────────────────────────────────────────────────────────▶│
     │                                                               │
     │                                          3. 验证用户名和密码  │
     │                                             UserStore.        │
     │                                             Authenticate()    │
     │                                                               │
     │                                          4. 生成 JWT token    │
     │                                             GenerateToken()   │
     │                                                               │
     │  5. 返回成功响应                                              │
     │     { success: true, token: "eyJ...", user: {...} }          │
     │◀──────────────────────────────────────────────────────────────┤
     │                                                               │
     │  6. 存储 token 到 localStorage                                │
     │     localStorage.setItem('jwt_token', token)                 │
     │                                                               │
     │  7. 更新状态                                                  │
     │     setIsAuthenticated(true)                                 │
     │     setJwtToken(token)                                       │
     │                                                               │
     │  8. 显示聊天界面                                              │
     │                                                               │
     ▼                                                               ▼
```

### 2. WebSocket 连接流程

```
┌──────────┐                                                    ┌──────────┐
│  前端    │                                                    │  后端    │
└────┬─────┘                                                    └────┬─────┘
     │                                                               │
     │  1. 登录成功后，获取 JWT token                                │
     │     const token = localStorage.getItem('jwt_token')          │
     │                                                               │
     │  2. 建立 WebSocket 连接                                       │
     │     ws://localhost:8080/ws?token=xxx                         │
     ├──────────────────────────────────────────────────────────────▶│
     │                                                               │
     │                                          3. 提取 token        │
     │                                             extractToken()    │
     │                                                               │
     │                                          4. 验证 token        │
     │                                             ValidateToken()   │
     │                                                               │
     │                                          5. 升级到 WebSocket  │
     │                                             upgrader.Upgrade()│
     │                                                               │
     │  6. 连接成功                                                  │
     │     ws.onopen = () => { ... }                                │
     │◀──────────────────────────────────────────────────────────────┤
     │                                                               │
     │  7. 可以发送和接收消息                                        │
     │                                                               │
     │  8. 发送消息                                                  │
     │     { content: "Hello, AI!" }                                │
     ├──────────────────────────────────────────────────────────────▶│
     │                                                               │
     │                                          9. 处理消息          │
     │                                             HandleClient      │
     │                                             Message()         │
     │                                                               │
     │  10. 接收响应                                                 │
     │      { Role: "assistant", Parts: [...] }                     │
     │◀──────────────────────────────────────────────────────────────┤
     │                                                               │
     │  11. 更新 UI                                                  │
     │      setMessages([...])                                      │
     │                                                               │
     ▼                                                               ▼
```

### 3. Token 验证流程

```
┌──────────┐                                                    ┌──────────┐
│  前端    │                                                    │  后端    │
└────┬─────┘                                                    └────┬─────┘
     │                                                               │
     │  1. 发送需要认证的请求                                        │
     │     GET /api/auth/verify                                     │
     │     Authorization: Bearer eyJ...                             │
     ├──────────────────────────────────────────────────────────────▶│
     │                                                               │
     │                                          2. 中间件拦截        │
     │                                             AuthMiddleware()  │
     │                                                               │
     │                                          3. 提取 token        │
     │                                             从 Authorization  │
     │                                             header            │
     │                                                               │
     │                                          4. 验证 token        │
     │                                             ValidateToken()   │
     │                                             - 检查签名        │
     │                                             - 检查过期        │
     │                                                               │
     │                                          5. 验证成功          │
     │                                             继续处理请求      │
     │                                                               │
     │  6. 返回响应                                                  │
     │     { valid: true, message: "Token is valid" }              │
     │◀──────────────────────────────────────────────────────────────┤
     │                                                               │
     ▼                                                               ▼

如果验证失败:

┌──────────┐                                                    ┌──────────┐
│  前端    │                                                    │  后端    │
└────┬─────┘                                                    └────┬─────┘
     │                                                               │
     │                                          验证失败             │
     │                                          - 无效签名           │
     │                                          - token 过期         │
     │                                          - token 缺失         │
     │                                                               │
     │  返回 401 Unauthorized                                        │
     │◀──────────────────────────────────────────────────────────────┤
     │                                                               │
     │  处理错误                                                     │
     │  - 清除 token                                                 │
     │  - 返回登录页                                                 │
     │                                                               │
     ▼                                                               ▼
```

## 数据流图

### JWT Token 结构

```
┌─────────────────────────────────────────────────────────────┐
│                      JWT Token                              │
│                                                             │
│  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.                     │
│  eyJ1c2VyX2lkIjoiNTA3YzciLCJ1c2VybmFtZSI6ImFkbWluIi...    │
│  SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c              │
│                                                             │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Header    │  │   Payload    │  │  Signature   │      │
│  │             │  │              │  │              │      │
│  │ {           │  │ {            │  │ HMACSHA256(  │      │
│  │   "alg":    │  │   "user_id": │  │   base64Url  │      │
│  │   "HS256",  │  │   "507c...", │  │   Encode(    │      │
│  │   "typ":    │  │   "username":│  │     header)  │      │
│  │   "JWT"     │  │   "admin",   │  │   + "." +    │      │
│  │ }           │  │   "exp":     │  │   base64Url  │      │
│  │             │  │   1735689600,│  │   Encode(    │      │
│  │             │  │   "iat":     │  │     payload) │      │
│  │             │  │   1735603200,│  │   ),         │      │
│  │             │  │   "iss":     │  │   secret     │      │
│  │             │  │   "crush-    │  │ )            │      │
│  │             │  │    server"   │  │              │      │
│  │             │  │ }            │  │              │      │
│  └─────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 消息流转

```
┌─────────────────────────────────────────────────────────────────┐
│                        消息生命周期                              │
└─────────────────────────────────────────────────────────────────┘

1. 用户输入消息
   ┌──────────────────────────────────────┐
   │ 前端: ChatPanel                      │
   │                                      │
   │ const newMessage = {                 │
   │   id: Date.now().toString(),        │
   │   role: 'user',                     │
   │   content: "Hello, AI!",            │
   │   timestamp: Date.now()             │
   │ }                                    │
   └──────────────────────────────────────┘
                    │
                    │ WebSocket.send()
                    ▼
2. WebSocket 传输
   ┌──────────────────────────────────────┐
   │ WebSocket 连接                       │
   │                                      │
   │ ws.send(JSON.stringify({            │
   │   content: "Hello, AI!"             │
   │ }))                                  │
   └──────────────────────────────────────┘
                    │
                    │
                    ▼
3. 后端接收
   ┌──────────────────────────────────────┐
   │ 后端: WebSocket Server               │
   │                                      │
   │ ws.ReadMessage()                     │
   │   ↓                                  │
   │ HandleClientMessage(msg)             │
   │   ↓                                  │
   │ Agent 处理                           │
   └──────────────────────────────────────┘
                    │
                    │
                    ▼
4. AI 响应
   ┌──────────────────────────────────────┐
   │ 后端: Agent                          │
   │                                      │
   │ response = {                         │
   │   ID: "msg_123",                    │
   │   Role: "assistant",                │
   │   Parts: [                          │
   │     { text: "Hello! ..." }          │
   │   ]                                  │
   │ }                                    │
   └──────────────────────────────────────┘
                    │
                    │ Broadcast()
                    ▼
5. 广播给客户端
   ┌──────────────────────────────────────┐
   │ 后端: WebSocket Server               │
   │                                      │
   │ for client in clients {             │
   │   client.WriteMessage(response)     │
   │ }                                    │
   └──────────────────────────────────────┘
                    │
                    │
                    ▼
6. 前端接收
   ┌──────────────────────────────────────┐
   │ 前端: App.tsx                        │
   │                                      │
   │ ws.onmessage = (event) => {         │
   │   const data = JSON.parse(event.data)│
   │   setMessages([...messages, data])  │
   │ }                                    │
   └──────────────────────────────────────┘
                    │
                    │
                    ▼
7. UI 更新
   ┌──────────────────────────────────────┐
   │ 前端: ChatPanel                      │
   │                                      │
   │ 显示 AI 的回复                       │
   │ "Hello! How can I help you?"        │
   └──────────────────────────────────────┘
```

## 组件关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                      前端组件层次                                │
└─────────────────────────────────────────────────────────────────┘

                        App.tsx
                           │
                           │ 管理全局状态
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
   LoginPage          ChatPanel          FileTree
        │                  │                  │
        │                  │                  │
        │                  ▼                  │
        │          ToolCallDisplay            │
        │                  │                  │
        │                  ▼                  │
        │          PermissionCard             │
        │                                     │
        └─────────────────┬─────────────────┘
                          │
                          ▼
                    CodeEditor


┌─────────────────────────────────────────────────────────────────┐
│                      后端模块层次                                │
└─────────────────────────────────────────────────────────────────┘

                        main.go
                           │
                           │ cmd.Execute()
                           │
                           ▼
                       cmd/root.go
                           │
                           │ setupApp()
                           │
                           ▼
                       app/app.go
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
   httpserver/        server/            auth/
   server.go          server.go          jwt.go
        │                  │              user.go
        │                  │              middleware.go
        │                  │                  │
        └──────────────────┴──────────────────┘
                           │
                           │ 使用认证模块
                           │
                           ▼
                      UserStore
                    (内存用户存储)
```

## 端口和协议

```
┌─────────────────────────────────────────────────────────────────┐
│                      网络通信图                                  │
└─────────────────────────────────────────────────────────────────┘

浏览器                                                    服务器
┌─────────┐                                          ┌─────────┐
│         │                                          │         │
│  :5173  │◀──────── HTTP (开发服务器) ─────────────│  Vite   │
│         │                                          │         │
└─────────┘                                          └─────────┘
     │
     │
     │ HTTP POST /api/auth/login
     │ HTTP GET  /api/auth/verify
     │ HTTP GET  /health
     │
     ▼
┌─────────┐                                          ┌─────────┐
│         │                                          │   Go    │
│  :8081  │◀──────── HTTP API ──────────────────────│  HTTP   │
│         │                                          │ Server  │
└─────────┘                                          └─────────┘


     │
     │ WebSocket /ws?token=xxx
     │
     ▼
┌─────────┐                                          ┌─────────┐
│         │                                          │   Go    │
│  :8080  │◀──────── WebSocket ─────────────────────│   WS    │
│         │          (双向通信)                      │ Server  │
└─────────┘                                          └─────────┘
```

## 安全边界

```
┌─────────────────────────────────────────────────────────────────┐
│                      安全层次                                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ Layer 1: 传输层安全                                              │
│                                                                  │
│  开发环境: HTTP / WS                                             │
│  生产环境: HTTPS / WSS (TLS 1.2+)                               │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ Layer 2: 应用层认证                                              │
│                                                                  │
│  - JWT Token 验证                                                │
│  - Token 过期检查                                                │
│  - 签名验证                                                      │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ Layer 3: 用户认证                                                │
│                                                                  │
│  - 用户名/密码验证                                               │
│  - 密码哈希比对                                                  │
│  - 用户存在性检查                                                │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ Layer 4: 数据保护                                                │
│                                                                  │
│  - 密码哈希存储 (SHA-256)                                        │
│  - Token 安全存储 (localStorage)                                │
│  - 敏感信息不记录日志                                            │
└─────────────────────────────────────────────────────────────────┘
```

---

**说明**: 本架构图展示了 Crush JWT 认证系统的完整结构和数据流。所有组件都已实现并可以正常工作。

