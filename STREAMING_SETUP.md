# WebSocket æµå¼æ¸²æŸ“è®¾ç½®å®Œæˆ

## å·²å®Œæˆçš„æ”¹è¿›

### 1. å‰ç«¯æ¶ˆæ¯ç±»å‹å¢å¼º (`crush-fe/src/types.ts`)
- æ·»åŠ äº† `ContentPart` å’Œ `BackendMessage` æ¥å£ï¼ŒåŒ¹é…åç«¯æ¶ˆæ¯ç»“æ„
- æ‰©å±• `Message` ç±»å‹ï¼Œæ”¯æŒï¼š
  - `reasoning`: æ˜¾ç¤º AI æ€è€ƒè¿‡ç¨‹
  - `isStreaming`: æ ‡è¯†æ¶ˆæ¯æ˜¯å¦æ­£åœ¨æµå¼ä¼ è¾“

### 2. WebSocket æ¶ˆæ¯è§£æä¼˜åŒ– (`crush-fe/src/App.tsx`)
- æ­£ç¡®è§£æåç«¯ `Parts` æ•°ç»„ï¼š
  - `text` ç±»å‹ â†’ ä¸»è¦å†…å®¹
  - `reasoning` ç±»å‹ â†’ æ€è€ƒè¿‡ç¨‹
- å®æ—¶æ›´æ–°æ¶ˆæ¯ï¼ˆé€šè¿‡ ID åŒ¹é…ï¼‰
- è·³è¿‡ç©ºæ¶ˆæ¯ï¼Œé¿å…æ˜¾ç¤ºä¸å®Œæ•´å†…å®¹

### 3. ChatPanel æ¸²æŸ“å¢å¼º (`crush-fe/src/components/ChatPanel.tsx`)

#### å®‰è£…çš„ä¾èµ–ï¼š
```bash
pnpm add react-markdown remark-gfm rehype-highlight @tailwindcss/typography highlight.js
```

#### æ–°å¢åŠŸèƒ½ï¼š
1. **Markdown æ¸²æŸ“**
   - ä½¿ç”¨ `react-markdown` è§£æ AI å“åº”
   - æ”¯æŒ GFM (GitHub Flavored Markdown)
   - ä»£ç å—è‡ªåŠ¨è¯­æ³•é«˜äº®

2. **æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º**
   - ç´«è‰²èƒŒæ™¯æ¡†æ˜¾ç¤º AI æ¨ç†è¿‡ç¨‹
   - åŒºåˆ†æ€è€ƒå†…å®¹å’Œæœ€ç»ˆå›ç­”

3. **æµå¼åŠ¨ç”»**
   - æ­£åœ¨ä¼ è¾“çš„æ¶ˆæ¯æœ‰è„‰å†²åŠ¨ç”»
   - å…‰æ ‡æ•ˆæœæŒ‡ç¤ºå†…å®¹æ­£åœ¨ç”Ÿæˆ

4. **æ ·å¼ä¼˜åŒ–**
   - ä»£ç å—ï¼šæ·±è‰²ä¸»é¢˜ + æ»šåŠ¨æ¡
   - å†…è”ä»£ç ï¼šç»¿è‰²é«˜äº®
   - åˆ—è¡¨ã€æ ‡é¢˜ã€å¼•ç”¨ç­‰å®Œæ•´æ”¯æŒ
   - Prose æ ·å¼è‡ªåŠ¨æ’ç‰ˆ

### 4. Tailwind é…ç½® (`crush-fe/tailwind.config.js`)
- æ·»åŠ  `@tailwindcss/typography` æ’ä»¶
- æ”¯æŒ `prose` ç±»å®ç°ä¼˜é›…çš„æ–‡æœ¬æ’ç‰ˆ

## æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨åç«¯ (ç«¯å£ 8080)
```bash
cd /Users/apple/crush/crush-main
go run main.go
```

åç«¯å°†åœ¨ `:8080` æä¾› WebSocket æœåŠ¡

### 2. å¯åŠ¨å‰ç«¯ (ç«¯å£ 5173)
```bash
cd /Users/apple/crush/crush-fe
pnpm run dev
```

è®¿é—® http://localhost:5173

### 3. æµ‹è¯•æµå¼æ¸²æŸ“

åœ¨èŠå¤©æ¡†ä¸­å‘é€æ¶ˆæ¯ï¼Œè§‚å¯Ÿï¼š

1. **ç”¨æˆ·æ¶ˆæ¯**ï¼šè“è‰²èƒŒæ™¯ï¼Œç«‹å³æ˜¾ç¤º
2. **AI æ€è€ƒè¿‡ç¨‹**ï¼ˆå¦‚æœæœ‰ï¼‰ï¼šç´«è‰²èƒŒæ™¯æ¡†ï¼Œæ˜¾ç¤ºæ¨ç†è¿‡ç¨‹
3. **AI å“åº”**ï¼š
   - æµå¼æ›´æ–°æ—¶æœ‰è„‰å†²åŠ¨ç”»
   - æ”¯æŒ Markdown æ ¼å¼
   - ä»£ç å—è‡ªåŠ¨é«˜äº®
   - åˆ—è¡¨ã€æ ‡é¢˜ç­‰æ­£ç¡®æ¸²æŸ“

## æ¸²æŸ“ç¤ºä¾‹

### AI å“åº”å°†æ”¯æŒï¼š

```markdown
# æ ‡é¢˜
è¿™æ˜¯**åŠ ç²—**æ–‡æœ¬å’Œ*æ–œä½“*æ–‡æœ¬ã€‚

## ä»£ç å—
\`\`\`python
def hello():
    print("Hello, World!")
\`\`\`

## åˆ—è¡¨
- é¡¹ç›® 1
- é¡¹ç›® 2
  - å­é¡¹ç›® 2.1

## å†…è”ä»£ç 
ä½¿ç”¨ `console.log()` è¾“å‡ºæ—¥å¿—ã€‚
```

### æ€è€ƒè¿‡ç¨‹æ˜¾ç¤ºï¼š
å½“ AI å‘é€ reasoning å†…å®¹æ—¶ï¼Œä¼šåœ¨ç´«è‰²æ¡†ä¸­æ˜¾ç¤ºï¼š
```
ğŸ’­ Thinking Process
[AI çš„æ¨ç†è¿‡ç¨‹...]
```

## æ¶æ„è¯´æ˜

### WebSocket æ¶ˆæ¯æµï¼š
```
ç”¨æˆ·è¾“å…¥
   â†“
å‰ç«¯ (5173) --WebSocket--> åç«¯ (8080)
   â†“                              â†“
æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯                  AgentCoordinator
   â†“                              â†“
   â†---------- æµå¼æ¨é€ -----------
   â†“
è§£æ Parts æ•°ç»„
   â†“
å®æ—¶æ›´æ–°/è¿½åŠ æ¶ˆæ¯
   â†“
Markdown æ¸²æŸ“ + ä»£ç é«˜äº®
```

### æ¶ˆæ¯ç»“æ„ï¼š
```typescript
{
  ID: "msg-123",
  Role: "assistant",
  Parts: [
    { type: "reasoning", data: { thinking: "..." } },
    { type: "text", data: { text: "..." } }
  ],
  UpdatedAt: 1234567890
}
```

## å…³é”®æ”¹è¿›ç‚¹

1. **æµå¼æ›´æ–°æœºåˆ¶**ï¼šé€šè¿‡æ¶ˆæ¯ ID åŒ¹é…ï¼Œå®ç°åŸåœ°æ›´æ–°è€Œéè¿½åŠ 
2. **å†…å®¹è§£æ**ï¼šæ­£ç¡®æå– `Parts` æ•°ç»„ä¸­çš„æ–‡æœ¬å’Œæ¨ç†å†…å®¹
3. **å¯è§†åŒ–å¢å¼º**ï¼šåŒºåˆ†æ€è€ƒè¿‡ç¨‹å’Œæœ€ç»ˆç­”æ¡ˆ
4. **Markdown æ”¯æŒ**ï¼šAI å¯ä»¥è¿”å›æ ¼å¼åŒ–çš„å“åº”
5. **ä»£ç é«˜äº®**ï¼šè‡ªåŠ¨è¯†åˆ«ä»£ç å—å¹¶é«˜äº®æ˜¾ç¤º

## åç»­ä¼˜åŒ–å»ºè®®

1. æ·»åŠ å¤åˆ¶ä»£ç æŒ‰é’®
2. æ”¯æŒå›¾ç‰‡æ¶ˆæ¯æ¸²æŸ“
3. æ·»åŠ å·¥å…·è°ƒç”¨ï¼ˆtool_callï¼‰çš„å¯è§†åŒ–
4. æ¶ˆæ¯å†å²è®°å½•æŒä¹…åŒ–
5. å¤šä¼šè¯æ”¯æŒ

## ç›¸å…³æ–‡ä»¶

- `crush-fe/src/types.ts` - ç±»å‹å®šä¹‰
- `crush-fe/src/App.tsx` - WebSocket è¿æ¥å’Œæ¶ˆæ¯ç®¡ç†
- `crush-fe/src/components/ChatPanel.tsx` - æ¶ˆæ¯æ¸²æŸ“ç»„ä»¶
- `crush-fe/tailwind.config.js` - æ ·å¼é…ç½®
- `crush-main/internal/server/server.go` - WebSocket æœåŠ¡å™¨
- `crush-main/internal/app/app.go` - æ¶ˆæ¯å¤„ç†é€»è¾‘

