# å·¥å…·è°ƒç”¨å’Œæƒé™ç¡®è®¤åŠŸèƒ½å®ç°

## åŠŸèƒ½æ¦‚è¿°

å·²å®Œæˆå‰ç«¯å·¥å…·è°ƒç”¨çš„å¯è§†åŒ–å±•ç¤ºå’Œæƒé™ç¡®è®¤æœºåˆ¶ï¼Œæ¨¡ä»¿åç«¯ TUI çš„æ¸²æŸ“æ–¹å¼ã€‚

## å®ç°çš„åŠŸèƒ½

### 1. å·¥å…·è°ƒç”¨å¯è§†åŒ– âœ…

#### å‰ç«¯ç»„ä»¶
- **`ToolCallDisplay.tsx`**: ä¸»è¦çš„å·¥å…·è°ƒç”¨å±•ç¤ºç»„ä»¶
  - æ˜¾ç¤ºå·¥å…·åç§°ï¼ˆæ ¼å¼åŒ–ï¼‰
  - æ˜¾ç¤ºå·¥å…·å‚æ•°ï¼ˆJSON æ ¼å¼åŒ–ï¼‰
  - æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ
  - æ”¯æŒå¤šç§çŠ¶æ€æ˜¾ç¤º

#### çŠ¶æ€æŒ‡ç¤º
- ğŸŸ¡ **Pending**: ç­‰å¾…æ‰§è¡Œï¼ˆé»„è‰²è¾¹æ¡†ï¼Œæ—¶é’Ÿå›¾æ ‡ï¼‰
- ğŸ”µ **Running**: æ­£åœ¨æ‰§è¡Œï¼ˆè“è‰²è¾¹æ¡†ï¼Œæ—‹è½¬æ—¶é’Ÿå›¾æ ‡ï¼Œ"Executing..." æ–‡æœ¬ï¼‰
- ğŸŸ¢ **Completed**: æ‰§è¡ŒæˆåŠŸï¼ˆç»¿è‰²è¾¹æ¡†ï¼Œå‹¾é€‰å›¾æ ‡ï¼‰
- ğŸ”´ **Error**: æ‰§è¡Œå¤±è´¥ï¼ˆçº¢è‰²è¾¹æ¡†ï¼Œé”™è¯¯å›¾æ ‡ï¼Œé”™è¯¯ä¿¡æ¯çº¢è‰²èƒŒæ™¯ï¼‰
- ğŸŸ  **Permission Required**: éœ€è¦æƒé™ï¼ˆæ©™è‰²è¾¹æ¡†ï¼Œè­¦å‘Šå›¾æ ‡ï¼‰

### 2. æƒé™ç¡®è®¤æœºåˆ¶ âœ…

#### å·¥ä½œæµç¨‹
```
ç”¨æˆ·å‘é€æ¶ˆæ¯
   â†“
Agent éœ€è¦æ‰§è¡Œå·¥å…·
   â†“
åç«¯å‘é€æƒé™è¯·æ±‚ (permission_request)
   â†“
å‰ç«¯æ˜¾ç¤ºæƒé™ç¡®è®¤æŒ‰é’®
   â†“
ç”¨æˆ·ç‚¹å‡» Approve/Deny
   â†“
å‰ç«¯å‘é€æƒé™å“åº” (permission_response)
   â†“
åç«¯æ‰§è¡Œ/æ‹’ç»å·¥å…·è°ƒç”¨
   â†“
å‰ç«¯æ˜¾ç¤ºæ‰§è¡Œç»“æœ
```

#### å‰ç«¯å®ç°
- **æƒé™è¯·æ±‚å­˜å‚¨**: ä½¿ç”¨ `Map<string, PermissionRequest>` ç®¡ç†å¾…å¤„ç†çš„æƒé™è¯·æ±‚
- **UI ç»„ä»¶**: 
  - Approve æŒ‰é’®ï¼ˆç»¿è‰²ï¼‰
  - Deny æŒ‰é’®ï¼ˆçº¢è‰²ï¼‰
  - æƒé™è¯·æ±‚æ ‡è¯†ï¼ˆæ©™è‰²ï¼‰

#### åç«¯å®ç°
- **æƒé™å¹¿æ’­**: åœ¨ `app.Subscribe()` ä¸­æ·»åŠ äº†æƒé™è¯·æ±‚å’Œé€šçŸ¥çš„å¹¿æ’­
- **æƒé™å¤„ç†**: åœ¨ `HandleClientMessage()` ä¸­å¤„ç†å‰ç«¯çš„æƒé™å“åº”

### 3. æ¶ˆæ¯ç±»å‹æ‰©å±• âœ…

#### æ–°å¢ç±»å‹å®šä¹‰ (`types.ts`)
```typescript
// å·¥å…·è°ƒç”¨
export interface ToolCall {
  id: string;
  name: string;
  input: string;
  provider_executed?: boolean;
  finished: boolean;
}

// å·¥å…·ç»“æœ
export interface ToolResult {
  tool_call_id: string;
  name: string;
  content: string;
  data?: string;
  mime_type?: string;
  metadata?: string;
  is_error: boolean;
}

// æƒé™è¯·æ±‚
export interface PermissionRequest {
  id: string;
  session_id: string;
  tool_call_id: string;
  tool_name: string;
  action?: string;
}

// æ¶ˆæ¯ç±»å‹æ‰©å±•
export type Message = {
  id: string;
  role: 'user' | 'assistant' | 'tool';
  content: string;
  reasoning?: string;
  timestamp: number;
  isStreaming?: boolean;
  toolCalls?: ToolCall[];
  toolResults?: ToolResult[];
};
```

### 4. WebSocket æ¶ˆæ¯å¤„ç† âœ…

#### æ¶ˆæ¯ç±»å‹

**1. æ™®é€šæ¶ˆæ¯**
```json
{
  "ID": "msg-123",
  "Role": "assistant",
  "Parts": [
    {"text": "I'll help you with that"},
    {"id": "tool-1", "name": "read_file", "input": "{\"path\":\"test.txt\"}", "finished": false}
  ]
}
```

**2. æƒé™è¯·æ±‚**
```json
{
  "Type": "permission_request",
  "id": "perm-123",
  "session_id": "sess-456",
  "tool_call_id": "tool-1",
  "tool_name": "read_file",
  "description": "Read file test.txt",
  "action": "read",
  "path": "/path/to/test.txt"
}
```

**3. æƒé™å“åº”ï¼ˆå‰ç«¯å‘é€ï¼‰**
```json
{
  "type": "permission_response",
  "id": "perm-123",
  "tool_call_id": "tool-1",
  "granted": true
}
```

**4. å·¥å…·ç»“æœ**
```json
{
  "ID": "msg-124",
  "Role": "tool",
  "Parts": [
    {
      "tool_call_id": "tool-1",
      "name": "read_file",
      "content": "File contents here...",
      "is_error": false
    }
  ]
}
```

### 5. è§£æé€»è¾‘ âœ…

#### å‰ç«¯è§£æ (`App.tsx`)
```typescript
// è§£æ Parts æ•°ç»„
data.Parts.forEach((part: any) => {
  // æ–‡æœ¬å†…å®¹
  if (part.text) {
    textContent += part.text;
  }
  
  // æ¨ç†å†…å®¹
  if (part.thinking) {
    reasoningContent += part.thinking;
  }
  
  // å·¥å…·è°ƒç”¨
  if (part.type === 'tool_call' || (part.id && part.name && part.input !== undefined)) {
    toolCalls.push({
      id: part.id,
      name: part.name,
      input: part.input || '',
      finished: part.finished || false,
    });
  }
  
  // å·¥å…·ç»“æœ
  if (part.type === 'tool_result' || part.tool_call_id) {
    toolResults.push({
      tool_call_id: part.tool_call_id,
      name: part.name || '',
      content: part.content || '',
      is_error: part.is_error || false,
    });
  }
});
```

#### åç«¯å¹¿æ’­ (`app.go`)
```go
// å¹¿æ’­æƒé™è¯·æ±‚
if event, ok := msg.(pubsub.Event[permission.PermissionRequest]); ok {
    app.WSServer.Broadcast(map[string]interface{}{
        "Type":        "permission_request",
        "id":          event.Payload.ID,
        "tool_call_id": event.Payload.ToolCallID,
        "tool_name":   event.Payload.ToolName,
        // ... å…¶ä»–å­—æ®µ
    })
}

// å¹¿æ’­æƒé™é€šçŸ¥
if event, ok := msg.(pubsub.Event[permission.PermissionNotification]); ok {
    app.WSServer.Broadcast(map[string]interface{}{
        "Type":        "permission_notification",
        "tool_call_id": event.Payload.ToolCallID,
        "granted":     event.Payload.Granted,
    })
}
```

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### å‰ç«¯æ–‡ä»¶
1. **`src/types.ts`** - æ·»åŠ  ToolCallã€ToolResultã€PermissionRequest ç±»å‹
2. **`src/components/ToolCallDisplay.tsx`** - å·¥å…·è°ƒç”¨å±•ç¤ºç»„ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰
3. **`src/components/ToolCallCard.tsx`** - å¤‡ç”¨å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶ï¼ˆæ–°åˆ›å»ºï¼‰
4. **`src/components/ChatPanel.tsx`** - é›†æˆå·¥å…·è°ƒç”¨æ˜¾ç¤º
5. **`src/App.tsx`** - æ·»åŠ æƒé™ç®¡ç†å’Œå·¥å…·è°ƒç”¨è§£æé€»è¾‘

### åç«¯æ–‡ä»¶
1. **`internal/app/app.go`**:
   - `Subscribe()` - æ·»åŠ æƒé™è¯·æ±‚å’Œé€šçŸ¥çš„å¹¿æ’­
   - `HandleClientMessage()` - å¤„ç†æƒé™å“åº”ï¼ˆå·²å­˜åœ¨ï¼‰

## æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡

**åç«¯**:
```bash
cd /Users/apple/crush/crush-main
go run main.go
```

**å‰ç«¯**:
```bash
cd /Users/apple/crush/crush-fe
pnpm run dev
```

### 2. æµ‹è¯•å·¥å…·è°ƒç”¨

1. åœ¨èŠå¤©æ¡†è¾“å…¥éœ€è¦å·¥å…·è°ƒç”¨çš„è¯·æ±‚ï¼Œä¾‹å¦‚ï¼š
   ```
   è¯·è¯»å– main.go æ–‡ä»¶çš„å†…å®¹
   ```

2. è§‚å¯Ÿå‰ç«¯æ˜¾ç¤ºï¼š
   - åº”è¯¥çœ‹åˆ°å·¥å…·è°ƒç”¨å¡ç‰‡ï¼ˆ`Read File` å·¥å…·ï¼‰
   - æ˜¾ç¤ºå‚æ•°ï¼ˆæ–‡ä»¶è·¯å¾„ï¼‰
   - å¦‚æœéœ€è¦æƒé™ï¼Œæ˜¾ç¤º Approve/Deny æŒ‰é’®

3. ç‚¹å‡» **Approve** æŒ‰é’®

4. è§‚å¯Ÿå·¥å…·æ‰§è¡Œï¼š
   - çŠ¶æ€å˜ä¸º "Running..."ï¼ˆè“è‰²ï¼Œæ—‹è½¬å›¾æ ‡ï¼‰
   - å®Œæˆåæ˜¾ç¤ºç»“æœï¼ˆç»¿è‰²è¾¹æ¡†ï¼‰
   - æˆ–æ˜¾ç¤ºé”™è¯¯ï¼ˆçº¢è‰²è¾¹æ¡†ï¼‰

### 3. æµ‹è¯•æƒé™æ‹’ç»

1. è¾“å…¥å¦ä¸€ä¸ªéœ€è¦æƒé™çš„è¯·æ±‚
2. ç‚¹å‡» **Deny** æŒ‰é’®
3. è§‚å¯Ÿå·¥å…·è°ƒç”¨è¢«æ‹’ç»

## UI æ•ˆæœç¤ºä¾‹

### å·¥å…·è°ƒç”¨å¡ç‰‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¡ ğŸ”§ Read File         Permission Required â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Approve]  [Deny]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parameters:                             â”‚
â”‚ {                                       â”‚
â”‚   "path": "/path/to/file.txt"          â”‚
â”‚ }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰§è¡Œä¸­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”µ ğŸ”§ Read File         Running...      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parameters:                             â”‚
â”‚ { "path": "/path/to/file.txt" }        â”‚
â”‚                                         â”‚
â”‚ â€¢ Executing...                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Œæˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¢ ğŸ”§ Read File                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parameters:                             â”‚
â”‚ { "path": "/path/to/file.txt" }        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Result:                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ package main                        â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ func main() {                       â”‚ â”‚
â”‚ â”‚   // ...                            â”‚ â”‚
â”‚ â”‚ }                                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”™è¯¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”´ ğŸ”§ Read File                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parameters:                             â”‚
â”‚ { "path": "/nonexistent.txt" }         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Error:                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ File not found: /nonexistent.txt    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®ç‰¹æ€§

1. **å®æ—¶æ›´æ–°**: å·¥å…·è°ƒç”¨çŠ¶æ€å®æ—¶æ›´æ–°ï¼ˆpending â†’ running â†’ completed/errorï¼‰
2. **æƒé™æ§åˆ¶**: ç”¨æˆ·å¯ä»¥æ‰¹å‡†æˆ–æ‹’ç»å·¥å…·æ‰§è¡Œ
3. **å‚æ•°å±•ç¤º**: JSON æ ¼å¼åŒ–æ˜¾ç¤ºå·¥å…·å‚æ•°
4. **ç»“æœå±•ç¤º**: æ¸…æ™°å±•ç¤ºæ‰§è¡Œç»“æœæˆ–é”™è¯¯ä¿¡æ¯
5. **çŠ¶æ€æŒ‡ç¤º**: é¢œè‰²å’Œå›¾æ ‡æ¸…æ™°æŒ‡ç¤ºå·¥å…·çŠ¶æ€
6. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„å·¥å…·ç±»å‹å’Œæ¸²æŸ“æ–¹å¼

## ä¸ TUI çš„å¯¹æ¯”

| åŠŸèƒ½ | TUI | Web UI |
|------|-----|--------|
| å·¥å…·è°ƒç”¨å±•ç¤º | âœ… | âœ… |
| æƒé™ç¡®è®¤ | âœ… | âœ… |
| å‚æ•°å±•ç¤º | âœ… | âœ… |
| ç»“æœå±•ç¤º | âœ… | âœ… |
| çŠ¶æ€åŠ¨ç”» | âœ… | âœ… |
| åµŒå¥—å·¥å…·è°ƒç”¨ | âœ… | ğŸ”„ (å¾…å®ç°) |
| å·¥å…·ç»“æœå¤åˆ¶ | âœ… | ğŸ”„ (å¾…å®ç°) |

## åç»­ä¼˜åŒ–å»ºè®®

1. **åµŒå¥—å·¥å…·è°ƒç”¨**: æ”¯æŒ Agent Tool çš„åµŒå¥—å·¥å…·è°ƒç”¨å±•ç¤º
2. **å¤åˆ¶åŠŸèƒ½**: æ·»åŠ å¤åˆ¶å·¥å…·å‚æ•°å’Œç»“æœçš„æŒ‰é’®
3. **å·¥å…·å†å²**: å±•ç¤ºå·¥å…·è°ƒç”¨å†å²è®°å½•
4. **æ‰¹é‡æƒé™**: æ”¯æŒæ‰¹é‡æ‰¹å‡†å¤šä¸ªå·¥å…·è°ƒç”¨
5. **å·¥å…·ç»Ÿè®¡**: æ˜¾ç¤ºå·¥å…·è°ƒç”¨ç»Ÿè®¡ä¿¡æ¯
6. **è‡ªå®šä¹‰æ¸²æŸ“**: ä¸ºä¸åŒå·¥å…·ç±»å‹æä¾›è‡ªå®šä¹‰æ¸²æŸ“å™¨

## ç›¸å…³æ–‡ä»¶

- `crush-fe/src/types.ts`
- `crush-fe/src/components/ToolCallDisplay.tsx`
- `crush-fe/src/components/ToolCallCard.tsx`
- `crush-fe/src/components/ChatPanel.tsx`
- `crush-fe/src/App.tsx`
- `crush-main/internal/app/app.go`
- `crush-main/internal/permission/permission.go`

